<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gym TV Normandie - LIVE</title>
    <style>
        /* BASE */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: Arial, sans-serif; }
        
        /* COUCHES MEDIAS */
        #media-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: black; }
        
        #bg-image { 
            width: 100%; height: 100%; 
            background-size: cover; 
            background-position: center; 
            display: none; 
        }
        
        #bg-video { 
            width: 100%; height: 100%; 
            /* 'contain' permet d'afficher toute la vidéo verticale sans couper le haut/bas */
            /* Si tu préfères que ça remplisse tout l'écran (zoomé), remplace 'contain' par 'cover' */
            object-fit: contain; 
            display: none; 
        }

        /* TEXTES */
        #main-title {
            position: absolute; top: 5%; left: 0; width: 100%;
            text-align: center; color: white; 
            font-size: 5vw; font-weight: bold;
            text-shadow: 3px 3px 8px #000;
            background: rgba(0,0,0,0.6); padding: 15px 0;
            z-index: 10;
        }

        #footer {
            position: fixed; bottom: 0; width: 100%; height: 80px;
            background: #D32F2F; z-index: 10; overflow: hidden;
            border-top: 3px solid white;
        }

        #scrolling-text {
            position: absolute; top: 15px; white-space: nowrap;
            color: white; font-size: 40px; font-weight: bold;
            left: 100%;
            animation: scroll 15s linear infinite;
        }

        @keyframes scroll { from { left: 100%; } to { left: -100%; } }

        /* DEBUG SCREEN (Caché si tout va bien) */
        #debug-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; color: red; z-index: 9999;
            padding: 40px; font-size: 24px; display: none;
        }
    </style>
</head>
<body>

    <div id="media-container">
        <div id="bg-image"></div>
        <video id="bg-video" muted playsinline loop></video>
    </div>

    <div id="main-title">Chargement...</div>
    
    <div id="footer">
        <div id="scrolling-text">Actualités Gym Normandie...</div>
    </div>

    <div id="debug-screen"></div>

<script>
    // =================================================================
    // TON LIEN EST ICI (Ne touche plus à rien !)
    var SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS3DKkK7eA4ncA6o7H8Xo4o8MeExhAWXfR_8qaW5MV9GmKBabIfVQZAwr_6HOeC36e821ynssLZOjDQ/pub?gid=1855203844&single=true&output=csv';
    // =================================================================

    var slides = [];
    var currentIndex = 0;

    function init() {
        loadData();
    }

    function loadData() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    parseCSV(xhr.responseText);
                } else {
                    // En cas d'erreur réseau, on réessaie dans 10 secondes
                    setTimeout(loadData, 10000);
                }
            }
        };
        // Ajout de l'heure pour forcer le rafraîchissement (anti-cache)
        xhr.open("GET", SHEET_URL + "&t=" + new Date().getTime(), true);
        xhr.send();
    }

    function parseCSV(text) {
        var rows = text.split('\n');
        slides = [];

        // Détection automatique du séparateur (Virgule ou Point-Virgule)
        var separator = (rows[0].indexOf(';') !== -1) ? ';' : ',';

        // Lecture ligne par ligne (sauf la ligne 0 qui est le titre)
        for (var i = 1; i < rows.length; i++) {
            var cols = rows[i].split(separator);
            if (cols.length >= 4) {
                var url = clean(cols[0]);
                var title = clean(cols[1]);
                var text = clean(cols[2]);
                var time = parseInt(clean(cols[3]));

                // On garde la ligne seulement si l'URL est valide et le temps est un chiffre
                if (url.length > 5 && !isNaN(time)) {
                    slides.push({ url: url, title: title, text: text, time: time * 1000 });
                }
            }
        }

        if (slides.length > 0) {
            document.getElementById('debug-screen').style.display = 'none';
            runSlideshow();
        } else {
            showFatalError("Tableau vide ou illisible. Vérifie ton Google Sheet.");
        }
    }

    function clean(str) { return str ? str.replace(/"/g, '').trim() : ""; }

    function runSlideshow() {
        var slide = slides[currentIndex];
        var imgDiv = document.getElementById('bg-image');
        var vidTag = document.getElementById('bg-video');
        
        // --- MISE A JOUR TEXTES ---
        document.getElementById('main-title').innerText = slide.title;
        var ticker = document.getElementById('scrolling-text');
        ticker.innerText = slide.text;
        
        // Reset animation texte
        ticker.style.animation = 'none';
        ticker.offsetHeight; 
        ticker.style.animation = "scroll 15s linear infinite";

        // --- GESTION MEDIA ---
        if (slide.url.toLowerCase().indexOf('.mp4') !== -1) {
            // C'EST UNE VIDEO
            imgDiv.style.display = 'none';
            vidTag.style.display = 'block';
            vidTag.src = slide.url;
            vidTag.muted = true;
            
            // Tentative de lecture
            var playPromise = vidTag.play();
            if (playPromise !== undefined) {
                playPromise.catch(function(error) {
                    console.log("Erreur lecture vidéo auto : " + error);
                });
            }
        } else {
            // C'EST UNE IMAGE
            vidTag.pause();
            vidTag.style.display = 'none';
            imgDiv.style.display = 'block';
            imgDiv.style.backgroundImage = "url('" + slide.url + "')";
        }

        // --- PREPARATION SUIVANT ---
        currentIndex++;
        if (currentIndex >= slides.length) {
            currentIndex = 0;
            // Fin de boucle : on recharge les données
            setTimeout(function() { loadData(); }, slide.time);
        } else {
            setTimeout(runSlideshow, slide.time);
        }
    }

    function showFatalError(msg) {
        var d = document.getElementById('debug-screen');
        d.style.display = 'block';
        d.innerHTML = "<h1>ERREUR</h1><p>" + msg + "</p>";
    }

    // Lancement
    init();

</script>
</body>
</html>
